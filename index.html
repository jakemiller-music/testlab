<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brass Buddy - Rhythmic Pitch Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            touch-action: manipulation;
        }
        .note-card {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .note {
            transition: all 0.2s ease-in-out;
            border: 4px solid transparent;
        }
        .note.active {
            transform: scale(1.1);
            border-color: #3b82f6; /* blue-500 */
        }
        .note.correct {
            background-color: #22c55e !important; /* green-500 */
            color: white;
            border-color: #16a34a; /* green-600 */
        }
        .note.incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white;
            border-color: #dc2626; /* red-600 */
            animation: shake 0.5s;
        }
        .note-rest {
            color: #6b7280; /* gray-500 */
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .tuner-bar {
            transition: transform 0.1s linear, opacity 0.2s;
        }
        #metronome-visual {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #9ca3af; /* gray-400 */
            transition: all 0.1s ease-in-out;
        }
        #metronome-visual.beat {
            transform: scale(1.5);
            background-color: #3b82f6; /* blue-500 */
        }
        #metronome-visual.accent {
             background-color: #ef4444; /* red-500 */
        }
        /* Custom slider track */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #E5E7EB; /* gray-200 */
            border-radius: 5px;
            outline: none;
        }
        /* Custom slider thumb */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3B82F6; /* blue-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3B82F6; /* blue-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 flex items-center justify-center min-h-screen">
    <div id="game-container" class="w-full max-w-2xl mx-auto p-4 md:p-6 text-center relative">
        
        <h1 class="text-4xl md:text-5xl font-bold text-blue-600 mb-2">Brass Buddy</h1>
        <p id="sub-heading" class="text-gray-500 mb-6">Train your ears and fingers!</p>
        
        <!-- Initial screen with instrument selection -->
        <div id="start-screen">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Choose Your Instrument</h2>
                <p class="mb-6">Select your instrument to load the correct exercises.</p>
                <div class="grid grid-cols-2 gap-4">
                    <button class="instrument-button bg-blue-600 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300" data-instrument="Trumpet">
                        Trumpet (Bâ™­)
                    </button>
                    <button class="instrument-button bg-green-600 text-white font-bold py-3 px-6 rounded-full hover:bg-green-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300" data-instrument="FrenchHorn">
                        French Horn (F)
                    </button>
                    <button class="instrument-button bg-yellow-600 text-white font-bold py-3 px-6 rounded-full hover:bg-yellow-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-300" data-instrument="Trombone">
                        Trombone (C)
                    </button>
                    <button class="instrument-button bg-red-600 text-white font-bold py-3 px-6 rounded-full hover:bg-red-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300" data-instrument="Tuba">
                        Tuba (C)
                    </button>
                </div>
            </div>
        </div>

        <!-- Main game UI (hidden initially) -->
        <div id="main-game" class="hidden">
            <div class="flex justify-center items-center mb-4 h-5">
                <div id="metronome-visual"></div>
            </div>
            
            <!-- Level Navigation -->
            <div id="level-controls" classs="flex items-center justify-between space-x-2 mb-4">
                <!-- NEW LAYOUT: Use flex to distribute buttons -->
                <div class="flex items-center justify-between w-full">
                    <button id="prev-level-button" class="bg-gray-300 text-gray-700 font-bold p-3 rounded-full hover:bg-gray-400 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    
                    <!-- Status display now flexible -->
                    <div id="status-display" class="text-lg md:text-xl h-12 flex items-center justify-center font-semibold text-blue-800 bg-blue-100 rounded-lg px-4 py-2 flex-1 mx-2">
                        Let's get started!
                    </div>

                    <button id="next-level-button" class="bg-gray-300 text-gray-700 font-bold p-3 rounded-full hover:bg-gray-400 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
            </div>
            <div id="level-name-display" class="text-sm text-gray-500 mb-4 h-4"></div>


            <!-- The musical pattern card -->
            <div id="pattern-card" class="note-card bg-white rounded-2xl p-6 mb-6 flex justify-center items-center space-x-4 h-48">
                <!-- Notes will be dynamically inserted here -->
            </div>

            <!-- Real-time feedback tuner -->
            <div id="tuner-container" class="mb-6 h-20 opacity-0 transition-opacity duration-300">
                <div class="text-sm text-gray-500 mb-1">Pitch Accuracy</div>
                <div class="relative w-full max-w-md mx-auto h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div class="absolute inset-0 flex justify-between items-center px-1">
                        <span class="text-xs font-bold text-red-500">Low</span>
                        <div class="w-1 h-4 bg-green-500 rounded-full transform -translate-x-1/2"></div>
                        <span class="text-xs font-bold text-red-500">High</span>
                    </div>
                    <div id="tuner-bar" class="absolute top-0 left-1/2 w-1 h-full bg-blue-600 rounded-full transform -translate-x-1/2"></div>
                </div>
                 <div id="pitch-debug" class="text-xs text-gray-400 mt-2 h-4"></div>
            </div>

            <!-- NEW: Main Control Bar -->
            <div id="main-controls" class="w-full max-w-sm mx-auto p-4 bg-white rounded-lg shadow-md flex justify-between items-center space-x-4">
                <button id="home-button" class="text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors focus:outline-none focus:ring-4 focus:ring-gray-300">
                    Change Instrument
                </button>
                
                <button id="pause-button" class="bg-blue-600 text-white font-bold w-14 h-14 rounded-full flex items-center justify-center text-3xl hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    <span id="pause-icon">II</span>
                    <span id="play-icon" class="hidden text-2xl pl-1">&#9658;</span>
                </button>
                
                <div class="flex-1"></div>
            </div>

            <!-- NEW: Tolerance Slider -->
            <div id="tolerance-slider-container" class="w-full max-w-sm mx-auto p-4 mt-4 bg-white rounded-lg shadow-md">
                <label for="tolerance-slider" class="block text-sm font-medium text-gray-700 mb-2">Pitch Forgiveness</label>
                <div class="flex items-center space-x-4">
                    <span class="text-xs text-gray-500">Strict</span>
                    <input id="tolerance-slider" type="range" min="20" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <span class="text-xs text-gray-500">Forgiving</span>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const mainGame = document.getElementById('main-game');
        
        // --- NEW: Updated controls ---
        const homeButton = document.getElementById('home-button');
        const pauseButton = document.getElementById('pause-button');
        const pauseIcon = document.getElementById('pause-icon');
        const playIcon = document.getElementById('play-icon');
        
        const statusDisplay = document.getElementById('status-display');
        const levelNameDisplay = document.getElementById('level-name-display');
        const prevLevelButton = document.getElementById('prev-level-button');
        const nextLevelButton = document.getElementById('next-level-button');

        const patternCard = document.getElementById('pattern-card');
        const tunerContainer = document.getElementById('tuner-container');
        const tunerBar = document.getElementById('tuner-bar');
        const pitchDebug = document.getElementById('pitch-debug');
        const metronomeVisual = document.getElementById('metronome-visual');

        // --- Instrument Data ---
        const INSTRUMENT_DATA = {
            'Trumpet': {
                displayName: 'Trumpet (Bâ™­)',
                notes: {
                    'C4': { freq: 233.08, color: 'bg-red-200' },     // Sounds Bâ™­3
                    'D4': { freq: 261.63, color: 'bg-orange-200' }, // Sounds C4
                    'E4': { freq: 293.66, color: 'bg-yellow-200' }, // Sounds D4
                    'F4': { freq: 329.63, color: 'bg-green-200' }, // Sounds Eâ™­4
                    'G4': { freq: 349.23, color: 'bg-blue-200' },   // Sounds F4
                    'Rest': { freq: 0, color: 'bg-gray-100' }
                },
                // NEW: 20 patterns
                patterns: [
                    { name: "First Notes", notes: ["C4", "C4", "Rest", "Rest"] },
                    { name: "Back and Forth", notes: ["C4", "D4", "C4", "Rest"] },
                    { name: "Step Up", notes: ["C4", "D4", "E4", "Rest"] },
                    { name: "Thirds", notes: ["C4", "E4", "C4", "Rest"] },
                    { name: "The Fifth", notes: ["C4", "G4", "C4", "Rest"] },
                    { name: "Scale Part 1", notes: ["C4", "D4", "E4", "F4"] },
                    { name: "Scale Part 2", notes: ["D4", "E4", "F4", "G4"] },
                    { name: "Top Note", notes: ["G4", "G4", "Rest", "Rest"] },
                    { name: "Down a Bit", notes: ["G4", "F4", "E4", "Rest"] },
                    { name: "Full Scale Up", notes: ["C4", "D4", "E4", "G4"] }, // Skip F4
                    { name: "Full Scale Down", notes: ["G4", "F4", "E4", "D4"] },
                    { name: "Arpeggio Up", notes: ["C4", "E4", "G4", "Rest"] },
                    { name: "Arpeggio Down", notes: ["G4", "E4", "C4", "Rest"] },
                    { name: "The Leap", notes: ["C4", "Rest", "G4", "Rest"] },
                    { name: "Call and Response", notes: ["C4", "C4", "D4", "D4"] },
                    { name: "Long Tone", notes: ["E4", "E4", "E4", "E4"] },
                    { name: "Rhythm 1", notes: ["C4", "Rest", "C4", "Rest"] },
                    { name: "Rhythm 2", notes: ["F4", "F4", "Rest", "F4"] },
                    { name: "Rhythm 3", notes: ["C4", "D4", "Rest", "E4"] },
                    { name: "The Finale", notes: ["C4", "E4", "G4", "G4"] },
                    { name: "Victory!", notes: [] }
                ]
            },
            'FrenchHorn': {
                displayName: 'French Horn (F)',
                // NEW: Corrected range C4-G4
                notes: {
                    'C4': { freq: 174.61, color: 'bg-red-200' },     // Sounds F3
                    'D4': { freq: 196.00, color: 'bg-orange-200' }, // Sounds G3
                    'E4': { freq: 220.00, color: 'bg-yellow-200' }, // Sounds A3
                    'F4': { freq: 233.08, color: 'bg-green-200' }, // Sounds Bâ™­3
                    'G4': { freq: 261.63, color: 'bg-blue-200' },   // Sounds C4
                    'Rest': { freq: 0, color: 'bg-gray-100' }
                },
                // NEW: 20 patterns for new range
                patterns: [
                    { name: "First Notes", notes: ["C4", "C4", "Rest", "Rest"] },
                    { name: "Back and Forth", notes: ["C4", "D4", "C4", "Rest"] },
                    { name: "Step Up", notes: ["C4", "D4", "E4", "Rest"] },
                    { name: "Thirds", notes: ["C4", "E4", "C4", "Rest"] },
                    { name: "The Fifth", notes: ["C4", "G4", "C4", "Rest"] },
                    { name: "Scale Part 1", notes: ["C4", "D4", "E4", "F4"] },
                    { name: "Scale Part 2", notes: ["D4", "E4", "F4", "G4"] },
                    { name: "Top Note", notes: ["G4", "G4", "Rest", "Rest"] },
                    { name: "Down a Bit", notes: ["G4", "F4", "E4", "Rest"] },
                    { name: "Full Scale Up", notes: ["C4", "D4", "E4", "G4"] }, // Skip F4
                    { name: "Full Scale Down", notes: ["G4", "F4", "E4", "D4"] },
                    { name: "Arpeggio Up", notes: ["C4", "E4", "G4", "Rest"] },
                    { name: "Arpeggio Down", notes: ["G4", "E4", "C4", "Rest"] },
                    { name: "The Leap", notes: ["C4", "Rest", "G4", "Rest"] },
                    { name: "Call and Response", notes: ["C4", "C4", "D4", "D4"] },
                    { name: "Long Tone", notes: ["E4", "E4", "E4", "E4"] },
                    { name: "Rhythm 1", notes: ["C4", "Rest", "C4", "Rest"] },
                    { name: "Rhythm 2", notes: ["F4", "F4", "Rest", "F4"] },
                    { name: "Rhythm 3", notes: ["C4", "D4", "Rest", "E4"] },
                    { name: "The Finale", notes: ["C4", "E4", "G4", "G4"] },
                    { name: "Victory!", notes: [] }
                ]
            },
            'Trombone': {
                displayName: 'Trombone (C)',
                notes: {
                    'Bâ™­2': { freq: 116.54, color: 'bg-red-200' },
                    'C3': { freq: 130.81, color: 'bg-orange-200' },
                    'D3': { freq: 146.83, color: 'bg-yellow-200' },
                    'Eâ™­3': { freq: 155.56, color: 'bg-green-200' },
                    'F3': { freq: 174.61, color: 'bg-blue-200' },
                    'Rest': { freq: 0, color: 'bg-gray-100' }
                },
                // NEW: 20 patterns
                patterns: [
                    { name: "First Notes", notes: ["Bâ™­2", "Bâ™­2", "Rest", "Rest"] },
                    { name: "Back and Forth", notes: ["Bâ™­2", "C3", "Bâ™­2", "Rest"] },
                    { name: "Step Up", notes: ["Bâ™­2", "C3", "D3", "Rest"] },
                    { name: "Thirds", notes: ["Bâ™­2", "D3", "Bâ™­2", "Rest"] },
                    { name: "The Fifth", notes: ["Bâ™­2", "F3", "Bâ™­2", "Rest"] },
                    { name: "Scale Part 1", notes: ["Bâ™­2", "C3", "D3", "Eâ™­3"] },
                    { name: "Scale Part 2", notes: ["C3", "D3", "Eâ™­3", "F3"] },
                    { name: "Top Note", notes: ["F3", "F3", "Rest", "Rest"] },
                    { name: "Down a Bit", notes: ["F3", "Eâ™­3", "D3", "Rest"] },
                    { name: "Full Scale Up", notes: ["Bâ™­2", "C3", "D3", "F3"] }, // Skip Eâ™­3
                    { name: "Full Scale Down", notes: ["F3", "Eâ™­3", "D3", "C3"] },
                    { name: "Arpeggio Up", notes: ["Bâ™­2", "D3", "F3", "Rest"] },
                    { name: "Arpeggio Down", notes: ["F3", "D3", "Bâ™­2", "Rest"] },
                    { name: "The Leap", notes: ["Bâ™­2", "Rest", "F3", "Rest"] },
                    { name: "Call and Response", notes: ["Bâ™­2", "Bâ™­2", "C3", "C3"] },
                    { name: "Long Tone", notes: ["D3", "D3", "D3", "D3"] },
                    { name: "Rhythm 1", notes: ["Bâ™­2", "Rest", "Bâ™­2", "Rest"] },
                    { name: "Rhythm 2", notes: ["Eâ™­3", "Eâ™­3", "Rest", "Eâ™­3"] },
                    { name: "Rhythm 3", notes: ["Bâ™­2", "C3", "Rest", "D3"] },
                    { name: "The Finale", notes: ["Bâ™­2", "D3", "F3", "F3"] },
                    { name: "Victory!", notes: [] }
                ]
            },
            'Tuba': {
                displayName: 'Tuba (C)',
                notes: {
                    // NEW: Corrected range Bâ™­1-F2
                    'Bâ™­1': { freq: 58.27, color: 'bg-red-200' },
                    'C2': { freq: 65.41, color: 'bg-orange-200' },
                    'D2': { freq: 73.42, color: 'bg-yellow-200' },
                    'Eâ™­2': { freq: 77.78, color: 'bg-green-200' },
                    'F2': { freq: 87.31, color: 'bg-blue-200' },
                    'Rest': { freq: 0, color: 'bg-gray-100' }
                },
                // NEW: 20 patterns for new range
                patterns: [
                    { name: "First Notes", notes: ["Bâ™­1", "Bâ™­1", "Rest", "Rest"] },
                    { name: "Back and Forth", notes: ["Bâ™­1", "C2", "Bâ™­1", "Rest"] },
                    { name: "Step Up", notes: ["Bâ™­1", "C2", "D2", "Rest"] },
                    { name: "Thirds", notes: ["Bâ™­1", "D2", "Bâ™­1", "Rest"] },
                    { name: "The Fifth", notes: ["Bâ™­1", "F2", "Bâ™­1", "Rest"] },
                    { name: "Scale Part 1", notes: ["Bâ™­1", "C2", "D2", "Eâ™­2"] },
                    { name: "Scale Part 2", notes: ["C2", "D2", "Eâ™­2", "F2"] },
                    { name: "Top Note", notes: ["F2", "F2", "Rest", "Rest"] },
                    { name: "Down a Bit", notes: ["F2", "Eâ™­2", "D2", "Rest"] },
                    { name: "Full Scale Up", notes: ["Bâ™­1", "C2", "D2", "F2"] }, // Skip Eâ™­2
                    { name: "Full Scale Down", notes: ["F2", "Eâ™­2", "D2", "C2"] },
                    { name: "Arpeggio Up", notes: ["Bâ™­1", "D2", "F2", "Rest"] },
                    { name: "Arpeggio Down", notes: ["F2", "D2", "Bâ™­1", "Rest"] },
                    { name: "The Leap", notes: ["Bâ™­1", "Rest", "F2", "Rest"] },
                    { name: "Call and Response", notes: ["Bâ™­1", "Bâ™­1", "C2", "C2"] },
                    { name: "Long Tone", notes: ["D2", "D2", "D2", "D2"] },
                    { name: "Rhythm 1", notes: ["Bâ™­1", "Rest", "Bâ™­1", "Rest"] },
                    { name: "Rhythm 2", notes: ["Eâ™­2", "Eâ™­2", "Rest", "Eâ™­2"] },
                    { name: "Rhythm 3", notes: ["Bâ™­1", "C2", "Rest", "D2"] },
                    { name: "The Finale", notes: ["Bâ™­1", "D2", "F2", "F2"] },
                    { name: "Victory!", notes: [] }
                ]
            }
        };

        // --- REFACTOR: Encapsulated Game Object ---
        const game = {
            // --- Configuration ---
            config: {
                NOTE_TOLERANCE_CENTS: 50, // Default, will be updated by slider
                MIN_NOTE_DURATION_MS: 120,
                BPM: 80,
                BEAT_INTERVAL_MS: 60000 / 80, // 750ms
                COUNT_IN_BEATS: 4,
                FEEDBACK_PAUSE_BEATS: 4
            },

            // --- Dynamic State ---
            state: {
                instrument: null,
                patternIndex: 0,
                currentPhase: 'idle', // 'idle', 'demo_count_in', 'demo_playing', 'user_count_in', 'user_playing', 'evaluation'
                globalBeat: 0,
                phaseStartBeat: 0,
                lastScore: 0,
                noteElements: [], // Store DOM elements to avoid re-querying
                currentInstrumentData: null,
                currentPattern: null,
                isPaused: false, // NEW: Pause state
            },

            // --- Audio Resources ---
            audio: {
                context: null,
                analyser: null,
                streamSource: null,
                buffer: null,
                isListening: false,
                isInitialized: false
            },

            // --- Timers ---
            timers: {
                metronome: null,
                pitchLoop: null
            },

            // --- Performance Tracking ---
            performance: {
                results: [],
                noteState: [],
                startTime: 0
            },

            // --- Core Methods ---
            async init(instrumentName) {
                try {
                    if (!this.audio.isInitialized) {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.audio.context = new (window.AudioContext || window.webkitAudioContext)();
                        this.audio.analyser = this.audio.context.createAnalyser();
                        this.audio.analyser.fftSize = 2048;
                        this.audio.buffer = new Float32Array(this.audio.analyser.fftSize);
                        this.audio.streamSource = this.audio.context.createMediaStreamSource(stream);
                        this.audio.streamSource.connect(this.audio.analyser);
                        this.audio.isInitialized = true;
                    }
                    
                    this.state.instrument = instrumentName;
                    this.state.currentInstrumentData = INSTRUMENT_DATA[instrumentName];
                    this.state.patternIndex = 0;
                    this.state.isPaused = false; // Ensure not paused on start
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');

                    startScreen.classList.add('hidden');
                    mainGame.classList.remove('hidden');
                    
                    document.getElementById('sub-heading').textContent = this.state.currentInstrumentData.displayName;
                    
                    this.loadPattern(this.state.patternIndex);
                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    startScreen.innerHTML = `<p class="text-red-500">Microphone access denied. Please allow access and refresh the page.</p>`;
                }
            },

            goHome() {
                this.stopMetronome();
                this.stopListening();
                this.state.instrument = null;
                this.state.currentInstrumentData = null;
                this.state.patternIndex = 0;
                this.state.currentPhase = 'idle';
                this.state.isPaused = false;

                mainGame.classList.add('hidden');
                startScreen.classList.remove('hidden');
                document.getElementById('sub-heading').textContent = "Train your ears and fingers!";
                metronomeVisual.classList.remove('beat', 'accent');
            },

            // NEW: Pause/Play functionality
            togglePause() {
                this.state.isPaused = !this.state.isPaused;
                pauseIcon.classList.toggle('hidden', this.state.isPaused);
                playIcon.classList.toggle('hidden', !this.state.isPaused);

                if (this.state.isPaused) {
                    this.stopListening();
                } else {
                    // Only resume listening if we were paused during the user's turn
                    if (this.state.currentPhase === 'user_playing') {
                        this.startListening();
                    }
                }
            },

            prevLevel() {
                if (this.state.patternIndex > 0) {
                    this.loadPattern(this.state.patternIndex - 1);
                }
            },

            nextLevel() {
                // Use new, larger pattern list
                if (this.state.patternIndex < this.state.currentInstrumentData.patterns.length - 2) { // -2 for "Victory!"
                    this.loadPattern(this.state.patternIndex + 1);
                }
            },

            loadPattern(index) {
                this.stopMetronome();
                this.stopListening();
                this.state.currentPhase = 'idle';
                this.state.patternIndex = index;
                this.state.currentPattern = this.state.currentInstrumentData.patterns[index];
                
                if (this.state.currentPattern.name === "Victory!") {
                    this.showVictoryScreen();
                    return;
                }
                
                statusDisplay.textContent = `Level ${index + 1}`;
                levelNameDisplay.textContent = this.state.currentPattern.name;
                patternCard.innerHTML = ''; 
                this.state.noteElements = []; 
                
                this.state.currentPattern.notes.forEach(noteName => {
                    const noteInfo = this.state.currentInstrumentData.notes[noteName];
                    const noteEl = document.createElement('div');
                    if (noteName === "Rest") {
                        noteEl.className = `note note-rest w-24 h-24 rounded-full flex items-center justify-center text-2xl font-bold ${noteInfo.color}`;
                        noteEl.textContent = "Rest";
                    } else {
                        noteEl.className = `note w-24 h-24 rounded-full flex items-center justify-center text-3xl font-bold ${noteInfo.color} text-gray-700`;
                        // Simple note name, remove octave
                        noteEl.textContent = noteName.replace(/[0-9]/g, '');
                    }
                    patternCard.appendChild(noteEl);
                    this.state.noteElements.push(noteEl);
                });
                
                this.updateNavButtons();
                this.startMetronome();
                this.transitionToState('demo_playing');
            },

            updateNavButtons() {
                if (!this.state.currentInstrumentData) return;
                prevLevelButton.disabled = this.state.patternIndex === 0;
                // Use new, larger pattern list
                nextLevelButton.disabled = this.state.patternIndex >= this.state.currentInstrumentData.patterns.length - 2;
            },

            showVictoryScreen() {
                 statusDisplay.textContent = "You completed all levels!";
                 levelNameDisplay.textContent = "Congratulations!";
                 patternCard.innerHTML = `<div class="text-center">
                    <h2 class="text-3xl font-bold text-green-600">Congratulations!</h2>
                    <p class="mt-2 text-lg">You are a Brass Buddy Champion!</p>
                 </div>`;
                 tunerContainer.classList.add('opacity-0');
                 metronomeVisual.classList.add('hidden');
                 prevLevelButton.disabled = false;
                 nextLevelButton.disabled = true;
                 this.stopMetronome();
            },

            // --- Metronome and State Machine ---

            startMetronome() {
                this.stopMetronome();
                this.state.globalBeat = -1;
                this.state.phaseStartBeat = 0;
                this.timers.metronome = setInterval(() => this.onBeat(), this.config.BEAT_INTERVAL_MS);
            },

            stopMetronome() {
                if (this.timers.metronome) {
                    clearInterval(this.timers.metronome);
                    this.timers.metronome = null;
                }
            },

            onBeat() {
                // NEW: Check for pause
                if (this.state.isPaused) return;

                this.state.globalBeat++;
                if (this.state.currentPhase === 'idle') return;

                this.pulseMetronome(this.state.globalBeat % 4 === 0);
                const beatsIntoPhase = this.state.globalBeat - this.state.phaseStartBeat;

                const phaseHandler = this.phases[this.state.currentPhase];
                if (phaseHandler) {
                    phaseHandler.call(this, beatsIntoPhase);
                }
            },

            phases: {
                demo_playing(beatsIntoPhase) {
                    const patternLength = this.state.currentPattern.notes.length;
                    if (beatsIntoPhase < patternLength) {
                        if (beatsIntoPhase === 0) {
                            if (this.state.currentPhase === 'demo_playing') {
                                statusDisplay.textContent = this.state.isRetry ? 'Listen again...' : 'Listen...';
                            }
                        }
                        const noteName = this.state.currentPattern.notes[beatsIntoPhase];
                        if (noteName !== "Rest") {
                            this.playTone(this.state.currentInstrumentData.notes[noteName].freq, (this.config.BEAT_INTERVAL_MS / 1000) - 0.05);
                        }
                        this.state.noteElements.forEach((el, index) => el.classList.toggle('active', index === beatsIntoPhase));
                    } else {
                        this.state.noteElements.forEach(el => el.classList.remove('active'));
                        this.transitionToState('user_playing');
                    }
                },

                user_playing(beatsIntoPhase) {
                    const patternLength = this.state.currentPattern.notes.length;
                    if (beatsIntoPhase >= patternLength) {
                        this.transitionToState('evaluation');
                    }
                },
                evaluation(beatsIntoPhase) {
                    if (beatsIntoPhase >= this.config.FEEDBACK_PAUSE_BEATS - 1) {
                        if (this.state.lastScore >= 0.65) {
                            this.loadPattern(this.state.patternIndex + 1);
                        } else {
                            this.transitionToState('demo_playing', { isRetry: true });
                        }
                    }
                }
            },

            transitionToState(newState, options = {}) {
                const oldState = this.state.currentPhase;
                
                if (oldState === 'user_playing') {
                    this.stopListening();
                }

                this.state.currentPhase = newState;
                this.state.phaseStartBeat = this.state.globalBeat + 1;
                this.state.isRetry = options.isRetry || false;
                
                switch (newState) {
                    case 'demo_playing':
                        // Status text is set in the phase handler
                        break;
                    
                    case 'user_playing':
                        this.performance.results = new Array(this.state.currentPattern.notes.length).fill(null);
                        this.performance.noteState = this.state.currentPattern.notes.map(() => ({ heldTime: 0, triggered: false }));
                        this.state.noteElements.forEach(el => el.className = el.className.replace(/ correct| incorrect/g, ''));
                        tunerContainer.classList.remove('opacity-0');

                        this.performance.startTime = this.audio.context.currentTime;
                        statusDisplay.textContent = 'Play now!';
                        this.startListening();
                        break;
                    case 'evaluation':
                        this.evaluatePerformance();
                        break;
                    case 'idle':
                        this.stopMetronome();
                        this.stopListening();
                        break;
                }
            },

            evaluatePerformance() {
                const pattern = this.state.currentPattern;
                let correctCount = 0;

                this.state.noteElements.forEach((el, index) => {
                    el.classList.remove('active');
                    if (this.performance.results[index] === 'correct') {
                        el.classList.add('correct');
                        correctCount++;
                    } else {
                        el.classList.add('incorrect');
                    }
                });

                this.state.lastScore = correctCount / pattern.notes.length;
                
                if (this.state.lastScore >= 0.65) {
                    statusDisplay.textContent = `Great job! ${correctCount}/${pattern.notes.length}`;
                } else {
                    statusDisplay.textContent = `Almost! ${correctCount}/${pattern.notes.length}. Try again.`;
                }
            },

            // --- Audio Processing ---

            startListening() {
                if (this.audio.isListening || this.state.isPaused) return;
                this.audio.isListening = true;
                this.detectPitch();
            },

            stopListening() {
                this.audio.isListening = false;
                if (this.timers.pitchLoop) {
                    cancelAnimationFrame(this.timers.pitchLoop);
                    this.timers.pitchLoop = null;
                }
                tunerContainer.classList.add('opacity-0');
                pitchDebug.textContent = '';
                this.state.noteElements.forEach(el => el.classList.remove('active'));
            },

            detectPitch() {
                if (!this.audio.isListening) return;
                
                if (this.state.currentPhase === 'user_playing') {
                    const pattern = this.state.currentPattern;
                    const notes = this.state.currentInstrumentData.notes;
                    // *** FIX: Use beat calculation, not elapsed time, for more robust sync ***
                    const beatsIntoPhase = this.state.globalBeat - this.state.phaseStartBeat;
                    const currentBeatIndex = beatsIntoPhase;

                    if (currentBeatIndex < 0 || currentBeatIndex >= pattern.notes.length) {
                        this.updateTuner(0, true);
                        this.timers.pitchLoop = requestAnimationFrame(() => this.detectPitch());
                        return;
                    }

                    this.state.noteElements.forEach((el, index) => el.classList.toggle('active', index === currentBeatIndex));

                    const targetNoteName = pattern.notes[currentBeatIndex];
                    const targetFreq = notes[targetNoteName].freq;
                    this.audio.analyser.getFloatTimeDomainData(this.audio.buffer);
                    const freq = this.getFundamentalFrequency(this.audio.buffer, this.audio.context.sampleRate);
                    
                    // Get tolerance from slider
                    this.config.NOTE_TOLERANCE_CENTS = parseInt(document.getElementById('tolerance-slider').value, 10);

                    if (targetNoteName === "Rest") {
                        if (!freq) { // Correctly resting
                            this.performance.noteState[currentBeatIndex].heldTime += 16;
                            if (this.performance.noteState[currentBeatIndex].heldTime > this.config.MIN_NOTE_DURATION_MS && !this.performance.noteState[currentBeatIndex].triggered) {
                                this.performance.results[currentBeatIndex] = 'correct';
                                this.performance.noteState[currentBeatIndex].triggered = true;
                            }
                        } else { // Made a sound
                            this.performance.noteState[currentBeatIndex].heldTime = 0;
                            this.performance.results[currentBeatIndex] = 'incorrect'; // Mark incorrect immediately on sound
                            this.performance.noteState[currentBeatIndex].triggered = true; // Prevent it from being marked correct later
                        }
                        this.updateTuner(0, true);
                        pitchDebug.textContent = 'Rest';

                    } else if (freq) { // Played a note
                        const diffCents = 1200 * Math.log2(freq / targetFreq);
                        this.updateTuner(diffCents);
                        pitchDebug.textContent = `Target: ${targetFreq.toFixed(1)} Hz, Your Pitch: ${freq.toFixed(1)} Hz`;

                        if (Math.abs(diffCents) < this.config.NOTE_TOLERANCE_CENTS) {
                            this.performance.noteState[currentBeatIndex].heldTime += 16;
                            if (this.performance.noteState[currentBeatIndex].heldTime > this.config.MIN_NOTE_DURATION_MS && !this.performance.noteState[currentBeatIndex].triggered) {
                                this.performance.results[currentBeatIndex] = 'correct';
                                this.performance.noteState[currentBeatIndex].triggered = true;
                            }
                        } else {
                            this.performance.noteState[currentBeatIndex].heldTime = 0;
                        }
                    } else { // No sound
                        this.performance.noteState[currentBeatIndex].heldTime = 0;
                        this.updateTuner(0, true);
                        pitchDebug.textContent = `Target: ${notes[targetNoteName].freq.toFixed(1)} Hz, Your Pitch: (silence)`;
                    }

                    // *** NEW: Final check at end of beat for notes not held long enough ***
                    const beatProgress = (this.state.globalBeat - this.state.phaseStartBeat) - currentBeatIndex;
                    if (beatProgress > 0.9 && this.performance.results[currentBeatIndex] === null) {
                        this.performance.results[currentBeatIndex] = 'incorrect';
                    }

                }
                
                this.timers.pitchLoop = requestAnimationFrame(() => this.detectPitch());
            },
            
            updateTuner(cents, hide = false) {
                tunerBar.style.opacity = hide ? '0' : '1';
                const clampedCents = Math.max(-100, Math.min(100, cents));
                // Scale 0-100%
                const percentage = (clampedCents + 100) / 200;
                // Scale -50% to +50% for transform
                const transformValue = (percentage * 100) - 50;
                tunerBar.style.transform = `translateX(${transformValue}%)`;
            },

            // --- Audio Utility Functions ---

            playTone(frequency, duration) {
                if (!this.audio.context) return;
                const oscillator = this.audio.context.createOscillator();
                const gainNode = this.audio.context.createGain();
                oscillator.type = 'sine'; // PURE SINE WAVE
                oscillator.frequency.setValueAtTime(frequency, this.audio.context.currentTime);
                
                // Use the existing fade-out logic
                gainNode.gain.setValueAtTime(0.5, this.audio.context.currentTime);
                const fadeOutTime = 0.05;
                if (duration > fadeOutTime) {
                    gainNode.gain.setValueAtTime(0.5, this.audio.context.currentTime + duration - fadeOutTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audio.context.currentTime + duration);
                } else {
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audio.context.currentTime + duration);
                }

                oscillator.connect(gainNode);
                gainNode.connect(this.audio.context.destination);
                oscillator.start();
                oscillator.stop(this.audio.context.currentTime + duration);
            },
            
            // REMOVED: playMetronomeClick() function

            pulseMetronome(isAccent = false) {
                 // REMOVED: this.playMetronomeClick();
                 metronomeVisual.classList.add('beat');
                 if (isAccent) metronomeVisual.classList.add('accent');
                 setTimeout(() => {
                     metronomeVisual.classList.remove('beat', 'accent');
                 }, 100);
            },
            
            getFundamentalFrequency(buffer, sampleRate) {
                // Using the existing stable algorithm
                const size = buffer.length;
                let maxSamples = Math.floor(size / 2);
                let bestOffset = -1;
                let bestCorrelation = 0;
                let rms = 0;
                for (let i = 0; i < size; i++) rms += buffer[i] * buffer[i];
                rms = Math.sqrt(rms / size);
                if (rms < 0.01) return null;

                let lastCorrelation = 1;
                for (let offset = 80; offset < maxSamples; offset++) {
                    let correlation = 0;
                    for (let i = 0; i < maxSamples; i++) {
                        correlation += Math.abs(buffer[i] - buffer[i + offset]);
                    }
                    correlation = 1 - (correlation / maxSamples);
                    if (correlation > 0.9 && correlation > lastCorrelation) {
                        if (correlation > bestCorrelation) {
                            bestCorrelation = correlation;
                            bestOffset = offset;
                        }
                    } else if (bestOffset !== -1) {
                        return sampleRate / bestOffset;
                    }
                    lastCorrelation = correlation;
                }
                if (bestCorrelation > 0.01) return sampleRate / bestOffset;
                return null;
            }
        };

        // --- Event Listeners ---
        document.querySelectorAll('.instrument-button').forEach(button => {
            button.addEventListener('click', () => {
                game.init(button.dataset.instrument);
            });
        });
        
        homeButton.addEventListener('click', () => game.goHome());
        pauseButton.addEventListener('click', () => game.togglePause()); // NEW
        prevLevelButton.addEventListener('click', () => game.prevLevel());
        nextLevelButton.addEventListener('click', () => game.nextLevel());

        document.getElementById('tolerance-slider').addEventListener('input', (e) => {
            // This is now handled inside detectPitch, but we can leave this.
            // Or, better, update the config value directly.
            game.config.NOTE_TOLERANCE_CENTS = parseInt(e.target.value, 10);
        });

    </script>
</body>
</html>

